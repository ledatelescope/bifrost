dist: bionic

language: python

python:
    - 2.7
    - 3.6
    # PyPy versions
    - pypy2.7-6.0
    - pypy3

services:
    - docker

jobs:
  include:
    - os: osx
      osx_image: xcode12
      language: sh
      env:
        - HOMEBREW_NO_INSTALL_CLEANUP=1
        - HOMEBREW_NO_ANALYTICS=1
        - HOMEBREW_NO_AUTO_UPDATE=1
    - stage: docker and deploy docs
      python: 2.7
      script:
        - make docker-cpu
        - make docker
        - bash ./.travis_deploy_docs.sh
  allow_failures:
    - python: 2.7
    - python: pypy2.7-6.0

addons:
    apt:
        update: true
        packages:
            - build-essential
            - ca-certificates
            - curl
            - git
            - pkg-config
            - software-properties-common
            - exuberant-ctags
            - python-dev
            - pylint
    homebrew:
        update: false
        packages:
            - curl
            - ctags-exuberant
            - gawk
            - git
            - gnu-sed
            - pkg-config
            - python3

before_install:
    - if [ "$TRAVIS_OS_NAME" = "osx" ]; then python3 -m pip install --upgrade virtualenv; fi
    - if [ "$TRAVIS_OS_NAME" = "osx" ]; then virtualenv -p python3 "$HOME/venv"; fi
    - if [ "$TRAVIS_OS_NAME" = "osx" ]; then source "$HOME/venv/bin/activate"; fi

install:
    - pip --no-cache-dir install \
        setuptools \
        numpy \
        matplotlib \
        contextlib2 \
        simplejson \
        pint \
        graphviz \
        git+https://github.com/olsonse/ctypesgen.git@9bd2d249aa4011c6383a10890ec6f203d7b7990f \
        coveralls \
        codecov
    - ./configure --disable-cuda
    - make -j all
    - sudo make install
    
script:
    - export LD_LIBRARY_PATH=/usr/local/lib:${LD_LIBRARY_PATH}
    - pip --no-cache-dir install \
        scipy
    - cd test && bash ./travis.sh && cd ..

env:
    global:
        - ENCRYPTION_LABEL: "886f75ecbd69"
        - COMMIT_AUTHOR_EMAIL: "travis@ledatelescope.github.io"

after_success:
    - cd test
    - coveralls
    - codecov
